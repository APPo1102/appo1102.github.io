<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>214æ•¸å­—ç·´ç¿’</title>
  <style>
    body { background: #111; color: white; font-family: sans-serif; justify-content: center; padding-top: 20px; }
    #game { width: 1280px; margin: auto; text-align: center; position: relative; }
    #modeDisplay { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
    #timer { position: absolute; top: 10px; right: 20px; font-size: 22px; color: #ff6666; }
    .platform-group { display: flex; justify-content: center; margin: 10px; gap: 70px; flex-wrap: wrap; }
    .pair { display: flex; gap: 10px; }
    .platform { width: 80px; height: 80px; border: 2px solid #555; background-color: #222; display: flex; align-items: center; justify-content: center; }
    .platform img { width: 70px; height: 70px; }
    #chatlog { background: #222; padding: 10px; margin-top: 20px; min-height: 150px; text-align: left; }
    input { padding: 6px; font-size: 16px; margin: 10px; width: 400px; }
    button { padding: 8px 20px; font-size: 16px; margin: 10px; }
    #controls, #recap { margin-top: 10px; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; color: yellow; }
    .comp-view { filter: brightness(0.5); }
    .recap-row { margin: 6px 0; }
    .correct-tile { outline: 4px solid lime; box-shadow: 0 0 10px lime; }
  </style>
</head>
<body>
  <div id="game">
    <div id="modeDisplay">æ®è½ä¹‹å¡”R2çœ‹æ•¸å­—ç·´ç¿’</div>
    <div id="timer">â±ï¸ 40</div>
    <button onclick="startGame()" id="startBtn">é–‹å§‹éŠæˆ²</button>
    <div class="platform-group" id="topRow" style="display:none;"></div>
    <div class="platform-group" id="bottomRow" style="display:none;"></div>
    <div id="chatlog"></div>
    <div id="controls" style="display:none;"><input id="inputBox" placeholder="è¼¸å…¥" /></div>
    <div id="recap" style="display:none;"></div>
    <div id="result"></div>
    <button onclick="startGame()" id="retryBtn" style="display:none;">é‡æ–°é–‹å§‹</button>
  </div>
  <div>
  <ul style="list-style: none;padding: 0;text-align: center;">
    <li>ç·´ç¿’èªªæ˜ï¼š</li>
    <li>é–‹å§‹ä¹‹å¾Œç”¨è‡ªå·±ç¿’æ…£çš„æ–¹å¼è¨˜éŒ„çœ‹åˆ°çš„æ•¸å­—</li>
    <li>è¼¸å…¥å¾Œé›»è…¦æœƒè‡ªå‹•çµ¦å…¶ä»–çœ‹ä¸è¦‹çš„æ•¸å­—ï¼Œä¸¦è·³è½‰åˆ°ä¸‹æ’æ•¸å­—</li>
    <li>å…©æ’æ•¸å­—éƒ½å‡ºä¾†ä¹‹å¾Œï¼Œåˆ†æˆæ¨“ä¸Šèˆ‡æ¨“ä¸‹æ•´ç†</li>
    <li>æ•´ç†å®Œæˆå¾Œï¼Œè¼¸å…¥"å…­å€‹ç›¸åŒ"çš„æ•¸å­—ï¼Œå³å¯å¾—åˆ°çµæœ</li>
  </ul>
  </div>
<script>
const SYMBOLS = ["â… ","â…¡","â…¢","â…£","â…¤","â…¥","â…¦","â…§"];
const SYMBOL_TO_NUM = { "â… ":"1", "â…¡":"2", "â…¢":"3", "â…£":"4", "â…¤":"5", "â…¥":"6", "â…¦":"7", "â…§":"8" };
const SYMBOL_IMG = Object.fromEntries(SYMBOLS.map((s,i)=>[s,`image/symbol_${i+1}.png`]));

const topRow = document.getElementById("topRow");
const bottomRow = document.getElementById("bottomRow");
const chatlog = document.getElementById("chatlog");
const inputBox = document.getElementById("inputBox");
const modeDisplay = document.getElementById("modeDisplay");
const resultBox = document.getElementById("result");
const controls = document.getElementById("controls");
const retryBtn = document.getElementById("retryBtn");
const startBtn = document.getElementById("startBtn");
const recapBox = document.getElementById("recap");
const timerDisplay = document.getElementById("timer");

let mode = "", symbols = [], step = 0;
let playerTopBrief = "", playerBotBrief = "", summaryTop = "", summaryBot = "", finalAnswer = "";
let playerTopIdx = [], playerBotIdx = [], compTopIdx = [], compBotIdx = [];
let timer = null, timeLeft = 40;

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function getValidSplit() {
  const invalid = [[0,6],[1,5],[5,1],[6,0]];
  let t, b;
  do {
    t = Math.floor(Math.random() * 6);
    b = 6 - t;
  } while (invalid.some(p => p[0] === t && p[1] === b));
  return [t, b];
}

function assignVisibility() {
  const [topCount, botCount] = getValidSplit();
  const shuffled = shuffle(Array.from({ length: 12 }, (_, i) => i));
  playerTopIdx = shuffled.filter(i => i < 6).slice(0, topCount);
  playerBotIdx = shuffled.filter(i => i >= 6).slice(0, botCount);
  compTopIdx = [...Array(6).keys()].filter(i => !playerTopIdx.includes(i));
  compBotIdx = [...Array(6).keys()].map(i => i + 6).filter(i => !playerBotIdx.includes(i));
}

function generateSymbols() {
  const main = SYMBOLS[Math.floor(Math.random() * 6)];
  const others = SYMBOLS.filter(s => s !== main);
  let base;
  
  const different = others.slice();
  const filler = different.length >= 6
    ? shuffle(different).slice(0, 6)
    : shuffle([...different, ...shuffle(SYMBOLS.filter(s => s !== main))]).slice(0, 6);
    base = Array(6).fill(main).concat(filler);  

  symbols = shuffle(base.slice(0, 12));
}

function startTimer() {
  clearInterval(timer);
  timeLeft = 40;
  timerDisplay.textContent = `â±ï¸ ${timeLeft}`;
  timer = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = `â±ï¸ ${timeLeft}`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      resultBox.innerHTML = "â° æ™‚é–“è¶…éï¼æ©Ÿåˆ¶å¤±æ•—ï¼";
      inputBox.disabled = true;
      retryBtn.style.display = "inline-block";
    }
  }, 1000);
}

function startGame() {
  clearInterval(timer);
  step = 0;
  playerTopBrief = playerBotBrief = summaryTop = summaryBot = finalAnswer = "";
  symbols = [];
  chatlog.innerHTML = '';
  resultBox.innerHTML = '';
  recapBox.innerHTML = '';
  inputBox.value = '';
  inputBox.disabled = false;
  recapBox.style.display = "none";
  retryBtn.style.display = "none";
  controls.style.display = "block";
  startBtn.style.display = "none";

  mode = Math.random() < 0.5 ? "open" : "closed";
  modeDisplay.textContent = `ğŸ‘ï¸ ç›®å‰æ¨¡å¼: ${mode === 'open' ? "çœçœ¼" : "é–‰çœ¼"}`;

  generateSymbols();
  assignVisibility();

  renderRow(topRow, [...Array(6).keys()], playerTopIdx,[2,1,1,2]);
  renderRow(bottomRow, [...Array(6).keys()].map(i => i + 6), playerBotIdx,[1,2,2,1]);

  topRow.style.display = "flex";
  bottomRow.style.display = "none";
  updatePlaceholder();
  startTimer();
}
function renderRow(row, indices, visibleSet) {
  row.innerHTML = ''; 
  for (let i = 0; i < indices.length; i+=3 ) {
    const pair = document.createElement("div");
    pair.className = "pair";
    for (let j = 0; j < 3; j++) {
      const idx = indices[i + j];
      if (typeof idx !== "number" || idx >= symbols.length) continue;
      const div = document.createElement("div");
      div.className = "platform";
      if (visibleSet.includes(idx)) {
        const sym = symbols[idx];
        if (sym && SYMBOL_IMG[sym]) {
          const img = document.createElement("img");
          img.src = SYMBOL_IMG[sym];
          div.appendChild(img);
        }
      }
      pair.appendChild(div);
    }
    row.appendChild(pair);
  }
}

function updatePlaceholder() {
  if (step <= 1) inputBox.placeholder = "é–‹å§‹æ©Ÿåˆ¶";
  else if (step <= 3) inputBox.placeholder = "è«‹è¼¸å…¥çœ‹åˆ°çš„æ•¸å­—";
  else inputBox.placeholder = "è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ";
}

function formatBrief(indices, visibleSet) {
  return indices.map((idx, i) =>
    (visibleSet.includes(idx) ? SYMBOL_TO_NUM[symbols[idx]] : '-') + ((i === 2) ? ' ' : '')
  ).join('').trim();
}

function handleInput(value) {
  if (!value.trim()) return;
  switch(step) {
    case 0:
      playerTopBrief = value;
      chatlog.innerHTML += `<div><strong>æˆ‘ï¼ˆæ¨“ä¸Šï¼‰:</strong> ${value}</div>`;
      chatlog.innerHTML += `<div><strong>é›»è…¦ï¼ˆæ¨“ä¸Šï¼‰:</strong> ${formatBrief([...Array(6).keys()], compTopIdx)}</div>`;
      topRow.style.display = "none"; bottomRow.style.display = "flex"; break;
    case 1:
      playerBotBrief = value;
      chatlog.innerHTML += `<div><strong>æˆ‘ï¼ˆæ¨“ä¸‹ï¼‰:</strong> ${value}</div>`;
      chatlog.innerHTML += `<div><strong>é›»è…¦ï¼ˆæ¨“ä¸‹ï¼‰:</strong> ${formatBrief([...Array(6).keys()].map(i=>i+6), compBotIdx)}</div>`;
      break;
    case 2: summaryTop = value; chatlog.innerHTML += `<div><strong>æˆ‘ï¼ˆæ¨“ä¸Šæ•´ç†ï¼‰:</strong> ${value}</div>`; break;
    case 3: summaryBot = value; chatlog.innerHTML += `<div><strong>æˆ‘ï¼ˆæ¨“ä¸‹æ•´ç†ï¼‰:</strong> ${value}</div>`; break;
    case 4:
      finalAnswer = value;
      judge();
      recapImages();
      retryBtn.style.display = "inline-block";
      clearInterval(timer); inputBox.disabled = true; break;
  }
  step++; inputBox.value = ''; updatePlaceholder();
}

function judge() {
  const counts = {};
  for (let i = 0; i < 12; i++) {
    const num = SYMBOL_TO_NUM[symbols[i]];
    counts[num] = (counts[num] || 0) + 1;
  }
  const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
  const [correct, count] = sorted[0];

  if (mode === 'open') {
    if (count !== 6) {
      resultBox.innerHTML = `âŒ ç­”éŒ¯äº†ï¼ ï¼ˆä¸æ˜¯6å€‹ç›¸åŒçš„æ•¸å­—ï¼‰`;
      return;
    }
    resultBox.innerHTML = finalAnswer === correct
      ? `âœ… æ­£ç¢ºç­”æ¡ˆï¼ˆçœçœ¼ï¼‰! ${correct}`
      : `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correct}`;
  } else {
    if (count !== 6) {
      resultBox.innerHTML = `âŒ ç­”éŒ¯äº†ï¼ ï¼ˆä¸æ˜¯10å€‹ç›¸åŒçš„æ•¸å­—ï¼‰`;
      return;
    }
    resultBox.innerHTML = finalAnswer === correct
      ? `âœ… æ­£ç¢ºç­”æ¡ˆï¼ˆé–‰çœ¼ï¼‰! ${correct}`
      : `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correct}`;
  }
}

function recapImages() {
  recapBox.style.display = 'block';
  recapBox.innerHTML = "<h3>ğŸ” æª¢æŸ¥ç­”æ¡ˆï¼šæˆ‘çœ‹åˆ°çš„æ•¸å­—/é›»è…¦æ•¸å­—</h3>";

  const counts = {};
  for (let i = 0; i < 12; i++) {
    const num = SYMBOL_TO_NUM[symbols[i]];
    counts[num] = (counts[num] || 0) + 1;
  }
  const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
  const [correct] = sorted[0];

  const correctIndices = mode === "open"
    ? symbols.map((s, i) => SYMBOL_TO_NUM[s] === correct ? i : null).filter(i => i !== null)
    : symbols.map((s, i) => SYMBOL_TO_NUM[s] !== correct ? i : null).filter(i => i !== null);

  const isCorrect = (idx) => correctIndices.includes(idx);

  const showRow = (title, indices, seen) => {
    const row = document.createElement("div");
    row.className = "recap-row";
    row.innerHTML = `<strong>${title}:</strong> `;
    indices.forEach(idx => {
      const sym = symbols[idx];
      const img = document.createElement("img");
      img.src = SYMBOL_IMG[sym];
      img.style.width = "60px";
      img.style.margin = "4px";
      if (!seen.includes(idx)) img.classList.add("comp-view");
      if (isCorrect(idx)) img.classList.add("correct-tile");
      row.appendChild(img);
    });
    recapBox.appendChild(row);
  };

  showRow("æ¨“ä¸Š", [...Array(6).keys()], playerTopIdx);
  showRow("æ¨“ä¸‹", [...Array(6).keys()].map(i => i + 6), playerBotIdx);
}

inputBox.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleInput(inputBox.value);
});
</script>
</body>
</html>